<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Daily Shop Sales</title>
<link rel="stylesheet" href="/static/style.css">
</head>

<body>

<h2>Daily Sales Entry</h2>
<button type="button" id="themeToggle">ðŸŒ™ Dark Mode</button>

<form id="salesForm">

<!-- ================= MAIN DETAILS ================= -->
<fieldset>
<legend>Main Details</legend>

<div class="form-row">
  <div class="form-group">
    <label>TNo</label>
    <input type="number" id="tno" value="{{ tno }}" disabled>
  </div>

  <div class="form-group">
    <label>Date</label>
    <input type="date" id="date">
    <small id="dateDisplay"></small>
  </div>
</div>

<div class="form-row">
  <div class="form-group">
    <label>Shop</label>
    <select id="shop">
      <option value="">--Select--</option>
      <option>53 Shop</option>
      <option>70 Shop</option>
    </select>
  </div>

  <div class="form-group">
    <label>Item</label>
    <input list="items" id="item">
    <datalist id="items"></datalist>
  </div>
</div>

<div class="form-row compact-row">
  <div class="form-group compact">
    <label>Total Kg</label>
    <input type="number" step="0.01" id="total_kg" value="0">
  </div>

  <div class="form-group compact">
    <label>Weight Loss</label>
    <input type="number" step="0.01" id="weight_loss" value="0">
  </div>

  <div class="form-group compact">
    <label>Damage</label>
    <input type="number" step="0.01" id="damage" value="0">
  </div>

  <div class="form-group compact">
    <label>Other</label>
    <input type="number" step="0.01" id="other" value="0">
  </div>
</div>
</fieldset>

<!-- ================= SALES ================= -->
<fieldset>
<legend>Sales</legend>

<div class="sales-grid">

  <div class="row header">
    <span class="type-col">Type</span>
    <span>Kg</span>
    <span>Rs</span>
  </div>

  <div class="row">
    <span class="type-col">Credit</span>
    <input id="credit_kg" type="number" step="0.01" value="0">
    <input id="credit_rs" type="number" step="0.01" value="0">
  </div>

  <script>
    for (let i = 1; i <= 6; i++) {
      document.write(`
      <div class="row">
        <span class="type-col">Cash ${i}</span>
        <input id="cash${i}_kg" type="number" step="0.01" value="0">
        <input id="cash${i}_rs" type="number" step="0.01" value="0">
      </div>
      `);
    }
  </script>

  <div class="row total">
    <span class="type-col">Stock Credit</span>
    <input id="stock_credit" disabled title="Auto calculated">
    <span></span>
  </div>

</div>
</fieldset>

<!-- ================= BUTTONS ================= -->
<div class="buttons">
  <button type="button" onclick="enableForm()">Add New</button>
  <button type="button" id="saveBtn" onclick="saveData()">Save</button>
  <button type="button" onclick="clearForm()">Clear</button>
  <button type="button" onclick="window.close()">Exit</button>
</div>

</form>

<!-- ================= SCRIPT ================= -->
<script>
const fields = document.querySelectorAll("input, select");
fields.forEach(f => f.disabled = true);

/* Date formatter */
function formatDDMMYYYY(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
}

/* Enable form */
function enableForm(){
  fields.forEach(f => f.disabled = false);
  tno.disabled = true;

  const today = new Date().toISOString().split("T")[0];
  date.value = today;
  dateDisplay.innerText = formatDDMMYYYY(today);
  window.stockWarned = false;
}

date.addEventListener("change",()=>{
  dateDisplay.innerText = formatDDMMYYYY(date.value);
});

/* Load items */
fetch("/items")
.then(r => r.json())
.then(list => {
  const dl = document.getElementById("items");
  list.forEach(i => {
    const o = document.createElement("option");
    o.value = i;
    dl.appendChild(o);
  });
});

/* Force zero if empty */
document.querySelectorAll('input[type="number"]').forEach(inp=>{
  inp.addEventListener("blur",()=>{
    if(inp.value === "") inp.value = "0";
  });
});

/* Stock calculation */
function calcStockCredit(){
  const totalKg = +total_kg.value || 0;
  const wl = +weight_loss.value || 0;
  const dmg = +damage.value || 0;
  const oth = +other.value || 0;
  const cr = +credit_kg.value || 0;

  let cashKg = 0;
  for(let i=1;i<=6;i++){
    cashKg += +document.getElementById(`cash${i}_kg`).value || 0;
  }

  const stock = totalKg - wl - dmg - oth - cr - cashKg;
  stock_credit.value = stock.toFixed(2);

  if(stock < 0){
    stock_credit.classList.add("negative-stock");
    stock_credit.classList.remove("stock-blink");
    void stock_credit.offsetWidth;
    stock_credit.classList.add("stock-blink");
    saveBtn.disabled = true;

    if(!window.stockWarned){
      alert("âš ï¸ Stock is negative. Please verify values.");
      window.stockWarned = true;
    }
  } else {
    stock_credit.classList.remove("negative-stock");
    saveBtn.disabled = false;
    window.stockWarned = false;
  }
}

[
  "total_kg","weight_loss","damage","other","credit_kg",
  "cash1_kg","cash2_kg","cash3_kg",
  "cash4_kg","cash5_kg","cash6_kg"
].forEach(id=>{
  document.getElementById(id).addEventListener("input", calcStockCredit);
});

/* Save */
function saveData(){
  let data = {};
  fields.forEach(f => !f.disabled && (data[f.id] = f.value));

  fetch("/save",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  })
  .then(r => r.json())
  .then(res=>{
    if(res.status === "success"){
      alert("Saved Successfully");
      tno.value = res.next_tno;
      clearForm();
    } else alert(res.message);
  });
}

/* Clear */
function clearForm(){
  fields.forEach(f=>{
    if(f.disabled) return;
    if(f.type === "number") f.value = "0";
    else f.value = "";
  });
  stock_credit.value = "";
  window.stockWarned = false;
}

/* Dark mode */
themeToggle.onclick = () => {
  document.body.classList.toggle("dark");
};
</script>

</body>
</html>
